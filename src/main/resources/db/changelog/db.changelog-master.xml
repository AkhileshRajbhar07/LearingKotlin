<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- Create tenant table -->
    <changeSet id="create-tenant-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="tenant"/>
            </not>
        </preConditions>
        <createTable tableName="tenant">
            <column name="mandant_uuid" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="street" type="VARCHAR(255)"/>
            <column name="zip" type="VARCHAR(20)"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE"/>
            <column name="updated_at" type="TIMESTAMP WITHOUT TIME ZONE"/>
        </createTable>
    </changeSet>

    <!-- Create company table -->
    <changeSet id="create-company-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="company"/>
            </not>
        </preConditions>
        <createTable tableName="company">
            <column name="company_uuid" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tenant_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="street" type="VARCHAR(255)"/>
            <column name="zip" type="VARCHAR(20)"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP" />
            <column name="updated_at" type="TIMESTAMP" />
        </createTable>
    </changeSet>

    <!-- Foreign key: One tenant -> Many companies -->
    <changeSet id="fk-company-tenant" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_company_tenant"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="company"
                baseColumnNames="tenant_uuid"
                referencedTableName="tenant"
                referencedColumnNames="mandant_uuid"
                constraintName="fk_company_tenant"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Create charger_station table -->
    <changeSet id="create-charger-station-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="charger_station"/>
            </not>
        </preConditions>
        <createTable tableName="charger_station">
            <column name="cp_uuid" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="mandant_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="company_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="pdc" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="chargebox_identity" type="VARCHAR(255)"/>
            <column name="label" type="VARCHAR(255)"/>
            <column name="street" type="VARCHAR(255)"/>
            <column name="zip" type="VARCHAR(20)"/>
            <column name="city" type="VARCHAR(255)"/>
            <column name="country_alpha2" type="VARCHAR(2)"/>
            <column name="created_at" type="TIMESTAMP" />
            <column name="updated_at" type="TIMESTAMP" />
        </createTable>
    </changeSet>

    <!-- Foreign key: One tenant -> Many charger stations -->
    <changeSet id="fk-charger-station-tenant" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_charger_station_tenant"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="charger_station"
                baseColumnNames="mandant_uuid"
                referencedTableName="tenant"
                referencedColumnNames="mandant_uuid"
                constraintName="fk_charger_station_tenant"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Foreign key: One company -> Many charger stations -->
    <changeSet id="fk-charger-station-company" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_charger_station_company"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="charger_station"
                baseColumnNames="company_uuid"
                referencedTableName="company"
                referencedColumnNames="company_uuid"
                constraintName="fk_charger_station_company"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Create connectors table -->
    <changeSet id="create-connectors-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="connectors"/>
            </not>
        </preConditions>
        <createTable tableName="connectors">
            <column name="connector_uuid" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charger_station_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="evse_search_string" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP" >
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" />
        </createTable>
    </changeSet>

    <!-- Foreign key: One charger_station -> Many connectors -->
    <changeSet id="fk-connectors-charger-station" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_connectors_charger_station"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="connectors"
                baseColumnNames="charger_station_uuid"
                referencedTableName="charger_station"
                referencedColumnNames="cp_uuid"
                constraintName="fk_connectors_charger_station"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Create charge_detail table -->
    <changeSet id="create-charge-detail-table" author="akhilesh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="charge_detail"/>
            </not>
        </preConditions>
        <createTable tableName="charge_detail">
            <column name="charge_log_uuid" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="connector_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="meter_start" type="FLOAT"/>
            <column name="meter_end" type="FLOAT"/>
            <column name="charge_log_end" type="TIMESTAMP"/>
            <column name="charge_log_rec_end" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" />
        </createTable>
    </changeSet>

    <!-- Foreign key: One connector -> Many charge_detail -->
    <changeSet id="fk-charge-detail-connector" author="akhilesh">
        <addForeignKeyConstraint
                baseTableName="charge_detail"
                baseColumnNames="connector_uuid"
                referencedTableName="connectors"
                referencedColumnNames="connector_uuid"
                constraintName="fk_charge_detail_connector"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Create session_sync_success_event table -->
    <changeSet id="create-session-sync-success-event-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="session_sync_success_event"/>
            </not>
        </preConditions>
        <createTable tableName="session_sync_success_event">
            <column name="session_sync_success_event_id" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_log_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="CLOB">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" >
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint
                baseTableName="session_sync_success_event"
                baseColumnNames="charge_log_uuid"
                constraintName="fk_session_charge_detail"
                referencedTableName="charge_detail"
                referencedColumnNames="charge_log_uuid"/>
    </changeSet>

    <!-- Create pending_session_event_sync table -->
    <changeSet id="create-pending-session-event-sync-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="pending_session_event_sync"/>
            </not>
        </preConditions>
        <createTable tableName="pending_session_event_sync">
            <column name="pending_session_event_sync_id" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_log_uuid" type="VARCHAR(50)"/>
            <column name="payload" type="jsonb"/>
            <column name="created_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>
    <changeSet id="fk-pending-session-event-sync-charge-detail" author="aklesh.rajbhar">
        <addForeignKeyConstraint
                baseTableName="pending_session_event_sync"
                baseColumnNames="charge_log_uuid"
                constraintName="fk_pending_session_event_sync_charge_detail"
                referencedTableName="charge_detail"
                referencedColumnNames="charge_log_uuid"
                onDelete="CASCADE"/>
    </changeSet>

    <!-- Create session_sync_failed_event table -->
    <changeSet id="create-session-sync-failed-event-table" author="aklesh">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="session_sync_failed_event"/>
            </not>
        </preConditions>
        <createTable tableName="session_sync_failed_event">
            <column name="session_sync_failed_event_id" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="charge_log_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB"/>
            <column name="reason" type="VARCHAR(255)"/>
            <column name="number_of_retries" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="fk-failed-session-event-sync-charge-detail" author="aklesh.rajbhar">
        <addForeignKeyConstraint
                baseTableName="session_sync_failed_event"
                baseColumnNames="charge_log_uuid"
                constraintName="fk_failed_session_event_sync_charge_detail"
                referencedTableName="charge_detail"
                referencedColumnNames="charge_log_uuid"
                onDelete="CASCADE"/>
    </changeSet>

    <!-- Create pending_charger_event_sync table -->
    <changeSet id="create-pending-charger-event-sync" author="akhilesh">
        <createTable tableName="pending_charger_event_sync">
            <column name="pending_charger_event_sync_id" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cp_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="fk-pending-charger-event-sync-charger-station" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk-pending-charger-event-sync-charger-station"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="pending_charger_event_sync"
                baseColumnNames="pending_charger_event_sync_id"
                referencedTableName="charger_station"
                referencedColumnNames="cp_uuid"
                constraintName="fk-pending-charger-event-sync-charger-station"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Create charger_sync_failed_event table -->
    <changeSet id="create-charger-sync-failed-event-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="charger_sync_failed_event"/>
            </not>
        </preConditions>
        <createTable tableName="charger_sync_failed_event">
            <column name="charger_sync_failed_event_id" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cp_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB"/>
            <column name="reason" type="VARCHAR(500)"/>
            <column name="number_of_retries" type="INTEGER" defaultValueNumeric="0"/>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE" >
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="fk-failed-charger-event-sync-charger-station" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk-failed-charger-event-sync-charger-station"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="charger_sync_failed_event"
                baseColumnNames="charger_sync_failed_event_id"
                referencedTableName="charger_station"
                referencedColumnNames="cp_uuid"
                constraintName="fk-failed-charger-event-sync-charger-station"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

    <!-- Create charger_sync_success_event table -->
    <changeSet id="create-charger-sync-success-event-table" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="charger_sync_success_event"/>
            </not>
        </preConditions>
        <createTable tableName="charger_sync_success_event">
            <column name="charger_sync_success_event_id" type="VARCHAR(50)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cp_uuid" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP WITHOUT TIME ZONE" >
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="fk-success-charger-event-sync-charger-station" author="aklesh.rajbhar">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk-success-charger-event-sync-charger-station"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
                baseTableName="charger_sync_success_event"
                baseColumnNames="charger_sync_success_event_id"
                referencedTableName="charger_station"
                referencedColumnNames="cp_uuid"
                constraintName="fk-success-charger-event-sync-charger-station"
                onDelete="CASCADE"
                onUpdate="CASCADE"/>
    </changeSet>

</databaseChangeLog>
